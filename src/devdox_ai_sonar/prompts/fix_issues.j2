Fix {{ language }} code for SonarQube rule: "{{ issue.message }}"

**Rule:** {{ issue.rule }} | **Severity:** {{ issue.severity }} | **Type:** {{ issue.type }}
**Root Cause:** {{ rule_info.get('root_cause', 'Code quality issue detected') }}

## CODE CONTEXT (Lines {{ context['start_line'] }}-{{ context['end_line'] }})
```{{ language }}
{{ code_chunk }}
```
{% if error_message %}## ERROR CONTEXT: {{ error_message }}{% endif %}

## CRITICAL SEPARATION RULES

ðŸš¨ **AVOID CODE DUPLICATION BETWEEN SECTIONS:**

1. **FIXED_SELECTION** = The modified version of the original lines
   - Contains CALLS to new functions/constants
   - Contains the actual logic changes
   - Should NOT contain new function/constant DEFINITIONS

2. **NEW_HELPER_CODE** = New code that needs to be added elsewhere
   - Contains DEFINITIONS of new functions/constants
   - Should NOT repeat any code from FIXED_SELECTION
   - Should NOT contain the original problematic code

## EXAMPLES OF CORRECT SEPARATION:

ðŸš¨ **FIXED_SELECTION MUST BE A SINGLE COMPLETE STRING**

âŒ **DO NOT DO THIS (Breaking into parts):**
{% raw %}
{
  "FIXED_SELECTION": "def function_name(self, args):",
  "code": "function_name",
  "docstring": "doc here",
  "logic": "logic here"
}
{% endraw %}

âœ… **CORRECT FORMAT:**
{% raw %}
{"FIXED_SELECTION": "def example():\n    return True", "NEW_HELPER_CODE": "", "PLACEMENT": "SIBLING"}
{% endraw %}

### âŒ WRONG (Duplication):
```
FIXED_SELECTION: "def validate():\n    if value is None:\n        return False\n    return True"
NEW_HELPER_CODE: "def validate():\n    if value is None:\n        return False\n    return True"
```

### âœ… CORRECT (Cognitive Complexity):
```
FIXED_SELECTION: "def process_data(data):\n    if not is_valid_data(data):\n        return None\n    return transform_data(data)"
NEW_HELPER_CODE: "def is_valid_data(data):\n    return data is not None and len(data) > 0\n\ndef transform_data(data):\n    return data.upper()"
```

### âœ… CORRECT (Literal Duplication):
```
FIXED_SELECTION: "def show_error():\n    print(ERROR_COLOR)\n\ndef highlight_text():\n    return ERROR_COLOR"
NEW_HELPER_CODE: "ERROR_COLOR = \\"red\\""
```

## INSTRUCTIONS
{% set fix_steps = rule_info.get('how_to_fix', {}).get('steps', []) %}
{% if fix_steps %}
{% for step in fix_steps %}
â€¢ {{ step }}
{% endfor %}
{% else %}
â€¢ Apply the appropriate fix for this SonarQube rule
â€¢ Follow code quality best practices
{% endif %}

{% if strategy_text %}
## ADDITIONAL STRATEGIES
{{ strategy_text }}
{% endif %}

## CRITICAL CODE FORMATTING REQUIREMENTS

ðŸš¨ **CODE MUST BE READABLE AND PROPERLY STRUCTURED**

### FORMATTING RULES:
â€¢ Use proper indentation (4 spaces for Python, 2 spaces for JavaScript)
â€¢ Each logical line should be on a separate \n
â€¢ Maintain consistent code structure and style
â€¢ Functions should be well-formed and complete
â€¢ Preserve original indentation patterns from the context

### PYTHON INDENTATION REQUIREMENTS:
â€¢ Function definitions: No leading indentation (unless in class)
â€¢ Function body: 4 spaces from function definition
â€¢ Nested blocks: Additional 4 spaces per level
â€¢ Class methods: 4 spaces from class definition
â€¢ Method body: 8 spaces from class definition

### EXAMPLE PROPER JSON FORMATTING:
{% raw %}
"NEW_HELPER_CODE": "def validate_input(data):\n    if not data:\n        return False\n    return isinstance(data, str) and len(data.strip()) > 0"
{% endraw %}

This represents properly formatted code:
```python
def validate_input(data):
    if not data:
        return False
    return isinstance(data, str) and len(data.strip()) > 0
```

## PLACEMENT DECISION LOGIC

**Follow this decision tree:**

1. **Is the NEW_HELPER_CODE an import or constant?**
   â†’ YES: Use "GLOBAL_TOP"

2. **Is the original code inside a class?**
   â†’ YES:
   a. Does the helper function definition contain `self` or `cls`?
      â†’ YES: Use "SIBLING"
      â†’ NO: The helper is NOT a class method â†’ Use "GLOBAL_BOTTOM"
   â†’ NO: Continue below

3. **Is the original code a module-level function?**
   â†’ YES: Is NEW_HELPER_CODE a function that logically relates?
   â†’ YES: Use "SIBLING"
   â†’ NO: Use "GLOBAL_BOTTOM"

4. **When in doubt:**
   - Constants/imports â†’ "GLOBAL_TOP"
   - Class-related methods â†’ "SIBLING"
   - Standalone utilities â†’ "GLOBAL_BOTTOM"

## CRITICAL PYTHON SYNTAX RULES (EXTREMELY IMPORTANT)

â€¢ ALL code you produce in FIXED_SELECTION and NEW_HELPER_CODE must be syntactically valid Python.
â€¢ NEVER produce broken or unterminated Python string literals.
â€¢ NEVER include unescaped internal quotes. Always escape internal " as \".
â€¢ ALWAYS generate clean indentation using the original code's indentation style.
â€¢ MULTILINE code MUST use \n inside JSON strings. Never use triple quotes.
â€¢ DO NOT wrap code inside markdown fences. No ```python, ```json, etc.
â€¢ DO NOT include stray commas, dangling backslashes, or partially escaped characters.
â€¢ If the original function is a class method (has `self` or `cls` in signature),
  helper functions MUST also include the same parameter if placed as a SIBLING.
â€¢ Helper functions WITHOUT `self` or `cls` MUST NOT be placed as SIBLING.

### OUTPUT SCOPE
- Return EXACTLY lines {{ context['start_line'] }}-{{ context['end_line'] }} (inclusive)
- Include ALL lines from this range, even if unchanged
- NO additional imports, classes, or function headers outside this range

Return EXACTLY lines {{ context['start_line'] }}-{{ context['end_line'] }} with minimal changes.

## CRITICAL JSON FORMAT REQUIREMENTS

1. Your ENTIRE response must be a single JSON object
2. Do NOT use markdown code blocks (no ``` json ```)
3. Do NOT use triple quotes for multi-line strings
4. Use \n for line breaks in strings
5. Escape quotes properly with \"
6. Do NOT include any text before or after the JSON

## JSON STRUCTURE REQUIRED

{% raw %}
{"FIXED_SELECTION": "Code with \n for newlines and \\" for quotes", "NEW_HELPER_CODE": "", "PLACEMENT": "SIBLING", "EXPLANATION": "Brief explanation", "CONFIDENCE": 0.8}
{% endraw %}

**PLACEMENT OPTIONS:** "SIBLING" | "GLOBAL_TOP" | "GLOBAL_BOTTOM"

**EXAMPLE VALID RESPONSE:**
{% raw %}
{"FIXED_SELECTION": "def example():\n    \\"\\"\\"Documentation.\\"\\"\\"\n    return True", "NEW_HELPER_CODE": "", "PLACEMENT": "SIBLING", "EXPLANATION": "Added documentation", "CONFIDENCE": 0.9}
{% endraw %}

YOUR ENTIRE RESPONSE MUST BE VALID JSON THAT PASSES json.loads()
